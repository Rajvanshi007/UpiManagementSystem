package com.tcs.controller;

import com.tcs.dto.TransferRequest;
import com.tcs.model.Account;
import com.tcs.model.Transaction;
import com.tcs.model.User;
import com.tcs.repository.AccountRepository;
import com.tcs.service.AccountService;
import com.tcs.service.OtpService;
import com.tcs.service.TransactionService;
import com.tcs.service.UserService;

import org.springframework.http.ResponseEntity;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.web.bind.annotation.*;

import java.util.Map;

@RestController
@RequestMapping("/api/otp")
public class OtpController {

    private final OtpService otpService;
    private final AccountService accountService;
    private final TransactionService transactionService;
    private final UserService userService;
    private final AccountRepository accountRepository;

    public OtpController(
            OtpService otpService,
            AccountService accountService,
            TransactionService transactionService,
            UserService userService,
            AccountRepository accountRepository
    ) {
        this.otpService = otpService;
        this.accountService = accountService;
        this.transactionService = transactionService;
        this.userService = userService;
        this.accountRepository=accountRepository;
    }

    // üîê GENERATE OTP
    @PostMapping("/generate")
    public ResponseEntity<String> generateOtp(
            @RequestBody Map<String, String> body) {

        String accountNumber = body.get("accountNumber");

        if (accountNumber == null || accountNumber.isBlank()) {
            return ResponseEntity.badRequest()
                    .body("Account number is required");
        }

        otpService.generateOtp(accountNumber);

        return ResponseEntity.ok("OTP generated successfully");
    }











@PostMapping("/transfer")
public void transfer(@RequestBody TransferRequest req) {

    if (!otpService.validateOtp(
            SecurityContextHolder.getContext()
                .getAuthentication().getName(),
            req.getOtp()
    )) {
        throw new RuntimeException("Invalid OTP");
    }

    Account from = accountService.getAccountById(req.getFromAccountId());

    Account to = accountRepository.findByAccountNumber(
        req.getToAccountNumber()
    ).orElseThrow(() -> new RuntimeException("Invalid account number"));

    if (from.getBalance() < req.getAmount())
        throw new RuntimeException("Insufficient balance");

    from.setBalance(from.getBalance() - req.getAmount());
    to.setBalance(to.getBalance() + req.getAmount());

    accountRepository.save(from);
    accountRepository.save(to);
}











}

