package com.tcs.controller;

import com.tcs.model.Account;
import com.tcs.model.AddMoneyRequest;
import com.tcs.model.Transaction;
import com.tcs.dto.TransferRequest;
import com.tcs.model.User;
import com.tcs.service.AccountService;
import com.tcs.service.OtpService;
import com.tcs.service.TransactionService;
import com.tcs.service.UserService;

import org.springframework.web.bind.annotation.*;

import java.time.LocalDateTime;
import java.util.List;

@RestController
@RequestMapping("/api/accounts")
public class AccountController {

    private final AccountService accountService;
    private final TransactionService transactionService;
    private final UserService userService;
    private final OtpService otpService;

    public AccountController(
            AccountService accountService,
            UserService userService,
            TransactionService transactionService,
            OtpService otpService
    ) {
        this.accountService = accountService;
        this.userService = userService;
        this.transactionService = transactionService;
        this.otpService=otpService;
    }


    // âœ… User Story 1: View accounts
    @GetMapping("/user/{userId}")
    public List<Account> getAccounts(@PathVariable Long userId) {
        return accountService.getAccountsByUser(userId);
    }

    // âœ… REQUIRED: Create account (for data setup)
    @PostMapping
    public Account createAccount(@RequestBody Account account) {
        return accountService.saveAccount(account);
    }

    @PostMapping("/add-money")
    public Account addMoney1(@RequestBody AddMoneyRequest req) {

        Account acc = accountService.getAccountById(req.getAccountId());

        if (req.getAmount() <= 0)
            throw new RuntimeException("Invalid amount");

        acc.setBalance(acc.getBalance() + req.getAmount());
        accountService.saveAccount(acc);

        Transaction txn = new Transaction();
        txn.setType("CREDIT");
        txn.setAmount(req.getAmount());
        txn.setDate(LocalDateTime.now());
        txn.setAccount(acc);

        transactionService.save(txn);

        return acc;
    }

    @PostMapping("/transfer")
    public void transfer(@RequestBody TransferRequest  req) {
        if (!otpService.validateOtp(req.getToUsername(), req.getOtp())) {
            throw new RuntimeException("Invalid or expired OTP");
        }

        Account from = accountService.getAccountById(req.getFromAccountId());

        User receiver = userService.findByUsername(req.getToUsername())
            .orElseThrow(() -> new RuntimeException("Receiver not found"));

        // ðŸ”¥ TRY TO GET SAVINGS ACCOUNT
        Account to;
        try {
            to = accountService.getAccountByUserAndType(
                receiver.getId(), "SAVINGS"
            );
        } catch (RuntimeException ex) {
            // ðŸ”¥ AUTO CREATE SAVINGS ACCOUNT
            to = new Account();
            to.setType("SAVINGS");
            to.setBalance(0);
            to.setUser(receiver);
            accountService.saveAccount(to);
        }

        if (req.getAmount() <= 0)
            throw new RuntimeException("Invalid amount");

        if (from.getBalance() < req.getAmount())
            throw new RuntimeException("Insufficient balance");

        // debit
        from.setBalance(from.getBalance() - req.getAmount());
        accountService.saveAccount(from);

        // credit
        to.setBalance(to.getBalance() + req.getAmount());
        accountService.saveAccount(to);
    }




}
