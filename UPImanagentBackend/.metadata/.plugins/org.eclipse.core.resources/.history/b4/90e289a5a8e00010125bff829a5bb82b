package com.tcs.controller;

import com.tcs.model.Account;
import com.tcs.model.AddMoneyRequest;
import com.tcs.model.Transaction;
import com.tcs.service.AccountService;
import com.tcs.service.TransactionService;
import com.tcs.service.UserService;

import org.springframework.web.bind.annotation.*;

import java.time.LocalDateTime;
import java.util.List;

@RestController
@RequestMapping("/api/accounts")
@CrossOrigin(origins = "http://localhost:4200")
public class AccountController {

    private final AccountService accountService;
    private final TransactionService transactionService;
    private final UserService userService;

    public AccountController(
            AccountService accountService,
            UserService userService,
            TransactionService transactionService
    ) {
        this.accountService = accountService;
        this.userService = userService;
        this.transactionService = transactionService;
    }


    // ✅ User Story 1: View accounts
    @GetMapping("/user/{userId}")
    public List<Account> getAccounts(@PathVariable Long userId) {
        return accountService.getAccountsByUser(userId);
    }

    // ✅ REQUIRED: Create account (for data setup)
    @PostMapping
    public Account createAccount(@RequestBody Account account) {
        return accountService.saveAccount(account);
    }
    @PostMapping("/add-money")
    public Account addMoney(@RequestBody AddMoneyRequest req) {

        Account account = accountService.getAccountById(req.getAccountId());

        if (req.getAmount() <= 0)
            throw new RuntimeException("Invalid amount");

        // update balance
        account.setBalance(account.getBalance() + req.getAmount());
        accountService.saveAccount(account);

        // save transaction
        Transaction txn = new Transaction();
        txn.setType("CREDIT");
        txn.setAmount(req.getAmount());
        txn.setDate(LocalDateTime.now());
        txn.setAccount(account);
        transactionService.save(txn);

        return account;
    }
    @PostMapping("/add-money")
    public Account addMoney1(@RequestBody AddMoneyRequest req) {

        Account acc = accountService.getAccountById(req.getAccountId());

        if (req.getAmount() <= 0)
            throw new RuntimeException("Invalid amount");

        acc.setBalance(acc.getBalance() + req.getAmount());
        accountService.saveAccount(acc);

        Transaction txn = new Transaction();
        txn.setType("CREDIT");
        txn.setAmount(req.getAmount());
        txn.setDate(LocalDateTime.now());
        txn.setAccount(acc);

        transactionService.save(txn);

        return acc;
    }


}
